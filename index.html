<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Terremotos España</title>
        <script
            src="https://code.jquery.com/jquery-3.4.1.js"
            integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
            crossorigin="anonymous"></script>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""/>
        <script
            src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    </head>
    <body>
        <div id="mapa" style="width: 1840px; height: 800px;"></div>
        <script>
            let earthquakeIcon = L.icon({
                iconUrl: 'terremoto.png',
                iconSize: [24, 24]
            });

            let baseMapLayer = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                maxZoom: 15,
                attribution: '© OpenStreetMap contributors'
            });

            let mainMap = L
                .map('mapa')
                .setView([
                    37.7305, -6.5356
                ], 6)
                .addLayer(baseMapLayer);

            $(document).ready(() => {
                let fetchEarthquakes = async function () {
                    let result;
                    await $.ajax({
                        'type': 'post',
                        'url': 'data.php',
                        'success': function (data) {
                            result = JSON.parse(data);
                        }
                    });
                    return result;
                }();

                fetchEarthquakes.then(function (data) {
                    for (i = 0; i < data.length; i++) {
                        let quakeLocation = [
                            data[i].lat,
                            data[i].long
                        ];
                        let quakeDetailsPopup =  data[i].time + data[i].date + "<br>" + "<a href='" + data[i].link + "' target='_blank'>" +
                                data[i].location + "</a> (" +
                                  data[i].magnitude + ")";
                        L
                            .marker(quakeLocation, {icon: earthquakeIcon})
                            .addTo(mainMap)
                            .bindPopup(quakeDetailsPopup);
                    }
                });
            });
        </script>
    </body>
</html>
